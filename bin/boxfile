#!/bin/bash

# source the Nos framework
. /opt/nos/common.sh

# source php common lib
. ../lib/php_common.sh

# initialize Nos with the original arguments
nos_init $@

is_webserver() {
  # find webserver
  webserver='apache'
  if [[ -n "$(payload 'boxfile_webserver')" ]]; then
    webserver=$(payload 'boxfile_webserver')
  fi
  if [[ "$webserver" = "$1" ]]; then
    echo "true"
  else
    echo "false"
  fi
}

is_interpreter() {
  # extract php interpreter
  interpreter="fpm"
  if [[ -n "$(payload 'boxfile_apache_php_interpreter')" ]]; then
    interpreter=$(payload 'boxfile_apache_php_interpreter')
  fi
  if [[ "${interpreter}" = "$1" ]]; then
    echo "true"
  else
    echo "false"
  fi
}

boxfile_json() {
  cat <<-END
{
  "apache": $(is_webserver 'apache'),
  "fpm": $(is_interpreter 'fpm'),
  "mod_php": $(is_interpreter 'mod_php'),
  "nginx": $(is_webserver 'nginx'),
  "builtin": $(is_webserver 'builtin'),
  "etc_dir": "$(payload 'etc_dir')",
  "deploy_dir": "$(payload 'deploy_dir')",
  "port": "$(payload 'port')",
  "live_dir": "$(payload 'live_dir')",
  "document_root": "$(builtin_document_root)"
}
END
}

template \
  "boxfile.mustache" \
  "-" \
  "$(boxfile_json)"
