#!/bin/bash

# echo "$(echo $1 | shon)"

# source the Nos framework
. /opt/nos/common.sh

# source php common lib
. ../lib/php_common.sh

# initialize Nos with the original arguments
nos_init $@

# Install PHP and dependencies
php_version=$(payload boxfile_php_version)
newrelic_license=$(payload newrelic_license)
webserver=$(payload boxfile_webserver)
use_fastcgi=$(fastcgi)
# php_extensions=$(payload boxfile_php_extensions)
# php_zend_extensions=$(payload boxfile_php_zend_extensions)
extensions_list=(${!php_extensions})
zend_extensions_list=(${!php_zend_extensions})

# echo "PL_boxfile_php_extensions_value: ${PL_boxfile_php_extensions_value[@]}"

# echo "use_fastcgi: $use_fastcgi"
# echo "php_extensions: $php_extensions"
# echo "php_zend_extensions: $php_zend_extensions"

if [[ -z "$php_version" ]]; then
  php_version="5.6"
fi
if [[ -z "$webserver" ]]; then
  webserver="apache"
fi
php_condensed_version=${php_version//./}

if [[ "${webserver}" = "apache" ]]; then
	install "apache-2.2"
	install "ap22-cloudflare"
	install "ap22-xsendfile"
	if [[ "$use_fastcgi" = "true" ]]; then
		install "ap22-fastcgi"
	else
		install "ap22-php${php_condensed_version}"
	fi
fi

# install "php${php_condensed_version}-bundle"
install "php-${php_version}"

if [[ "${PL_boxfile_php_extensions_type}" = "array" ]]; then
	for ((i=0; i < PL_boxfile_php_extensions_length ; i++)); do
		type=PL_boxfile_php_extensions_${i}_type
		value=PL_boxfile_php_extensions_${i}_value
		if [[ ${!type} = "string" ]]; then
			install php${php_condensed_version}-${!value}
		fi
	done
fi

if [[ "${PL_boxfile_php_zend_extensions_type}" = "array" ]]; then
	for ((i=0; i < PL_boxfile_php_zend_extensions_length ; i++)); do
		type=PL_boxfile_php_zend_extensions_${i}_type
		value=PL_boxfile_php_zend_extensions_${i}_value
		if [[ ${!type} = "string" ]]; then
			install php${php_condensed_version}-${!value}
		fi
	done
fi

# Make environment variables and configuration files
etc_dir=$(payload 'etc_dir')
deploy_dir=$(payload 'deploy_dir')
mkdir -p ${etc_dir}/php
mkdir -p ${etc_dir}/php.d
mkdir -p ${etc_dir}/httpd
mkdir -p ${deploy_dir}/var/log/httpd
mkdir -p ${deploy_dir}/var/log/php
mkdir -p ${deploy_dir}/var/run
mkdir -p ${deploy_dir}/var/tmp

persist_evars
create_apache_conf
[[ "$use_fastcgi" = "true" ]] && create_php_fpm_conf
create_php_ini
[[ -n "$newrelic_license" ]] && create_php_newrelic_ini

if [[ "${PL_boxfile_php_extensions_type}" = "array" ]]; then
	for ((i=0; i < PL_boxfile_php_extensions_length ; i++)); do
		type=PL_boxfile_php_extensions_${i}_type
		value=PL_boxfile_php_extensions_${i}_value
		if [[ ${!type} = "string" ]]; then
			[[ -f ../templates/php/php.d/${!value}.ini.mustache ]] && eval create_php_${!value}_ini
		fi
	done
fi

if [[ "${PL_boxfile_php_zend_extensions_type}" = "array" ]]; then
	for ((i=0; i < PL_boxfile_php_zend_extensions_length ; i++)); do
		type=PL_boxfile_php_zend_extensions_${i}_type
		value=PL_boxfile_php_zend_extensions_${i}_value
		if [[ ${!type} = "string" ]]; then
			[[ -f ../templates/php/php.d/${!value}.ini.mustache ]] && eval create_php_${!value}_ini
		fi
	done
fi
